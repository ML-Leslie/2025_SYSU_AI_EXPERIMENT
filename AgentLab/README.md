## ðŸ“Œç›®å½•
- [ðŸ“Œç›®å½•](#ç›®å½•)
- [äººå·¥æ™ºèƒ½å®žéªŒæŠ¥å‘Š LangGraphå¤šæ™ºèƒ½ä½“åä½œ](#äººå·¥æ™ºèƒ½å®žéªŒæŠ¥å‘Š-langgraphå¤šæ™ºèƒ½ä½“åä½œ)
  - [ä¸€ã€å®žéªŒç›®çš„](#ä¸€å®žéªŒç›®çš„)
  - [äºŒã€å®žéªŒå†…å®¹](#äºŒå®žéªŒå†…å®¹)
    - [1. èƒŒæ™¯\&ç®—æ³•åŽŸç†](#1-èƒŒæ™¯ç®—æ³•åŽŸç†)
    - [2. å…³é”®ä»£ç å±•ç¤º](#2-å…³é”®ä»£ç å±•ç¤º)
      - [1. çŠ¶æ€å®šä¹‰ (AgentState)](#1-çŠ¶æ€å®šä¹‰-agentstate)
      - [2. å®šä¹‰å·¥å…· (Tools)](#2-å®šä¹‰å·¥å…·-tools)
      - [3. ç»“æž„åŒ–è¾“å‡ºï¼ˆPydantic Modelsï¼‰](#3-ç»“æž„åŒ–è¾“å‡ºpydantic-models)
      - [4. æ™ºèƒ½ä½“èŠ‚ç‚¹ (Agents)](#4-æ™ºèƒ½ä½“èŠ‚ç‚¹-agents)
        - [(1) chief\_planner\_agent](#1-chief_planner_agent)
        - [(2) expert\_agent\_react](#2-expert_agent_react)
        - [(3) report\_generator\_agent](#3-report_generator_agent)
      - [5. å®šä¹‰å›¾ (Graph)](#5-å®šä¹‰å›¾-graph)
      - [6. ä¸»å‡½æ•°è°ƒç”¨](#6-ä¸»å‡½æ•°è°ƒç”¨)
    - [3. åˆ›æ–°ç‚¹\&ä¼˜åŒ–](#3-åˆ›æ–°ç‚¹ä¼˜åŒ–)
  - [ä¸‰ã€å®žéªŒç»“æžœåŠåˆ†æž](#ä¸‰å®žéªŒç»“æžœåŠåˆ†æž)
    - [å®žéªŒç»“æžœ](#å®žéªŒç»“æžœ)
    - [åˆ†æž](#åˆ†æž)
    - [æ½œåœ¨é—®é¢˜](#æ½œåœ¨é—®é¢˜)
  - [å››ã€å‚è€ƒæ–‡çŒ®](#å››å‚è€ƒæ–‡çŒ®)

---

## äººå·¥æ™ºèƒ½å®žéªŒæŠ¥å‘Š LangGraphå¤šæ™ºèƒ½ä½“åä½œ

### ä¸€ã€å®žéªŒç›®çš„

  - ä½¿ç”¨ LangChain å’Œ LangGraph æ¡†æž¶è®¾è®¡å¹¶å®žçŽ°ä¸€ä¸ªå¤šæ™ºèƒ½ä½“ï¼ˆMulti-Agentï¼‰åä½œç³»ç»Ÿï¼Œå®Œæˆä¸€ä¸ªå¤æ‚çš„ã€å¤šæ­¥éª¤çš„æ—…è¡Œè®¡åˆ’å®šåˆ¶ä»»åŠ¡ã€‚
  - æ·±å…¥ç†è§£å’Œåº”ç”¨æ™ºèƒ½ä½“è®¾è®¡çš„æ ¸å¿ƒæ¨¡å¼ï¼ŒåŒ…æ‹¬ ReActï¼ˆReasoning and Actingï¼‰ã€Reflectionï¼ˆåæ€ä¿®æ­£ï¼‰ä»¥åŠå·¥å…·ï¼ˆToolsï¼‰è°ƒç”¨ã€‚
  - æŽŒæ¡ä½¿ç”¨çŠ¶æ€å›¾ï¼ˆStateGraphï¼‰æ¥æž„å»ºå’ŒæŽ§åˆ¶éžçº¿æ€§çš„ã€å¯å¾ªçŽ¯çš„å¤æ‚æ™ºèƒ½ä½“å·¥ä½œæµï¼Œå®žçŽ°æ™ºèƒ½ä½“ä¹‹é—´çš„æœ‰æ•ˆååŒå’Œä»»åŠ¡è·¯ç”±ã€‚

### äºŒã€å®žéªŒå†…å®¹

#### 1\. èƒŒæ™¯&ç®—æ³•åŽŸç†

- æœ¬å®žéªŒæž„å»ºäº†ä¸€ä¸ª**æ¨¡æ‹Ÿé«˜ç«¯æ—…è¡Œå®šåˆ¶å·¥ä½œå®¤**çš„ AI ç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿç”±å¤šä¸ªæ‹¥æœ‰ä¸åŒèŒè´£çš„æ™ºèƒ½ä½“ç»„æˆã€‚å®ƒä»¬åœ¨ä¸€ä¸ªé¢„å®šä¹‰çš„å›¾ï¼ˆGraphï¼‰ç»“æž„ä¸­ååŒå·¥ä½œï¼Œå…±åŒå®Œæˆä»Žç”¨æˆ·éœ€æ±‚åˆ†æžåˆ°ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šçš„å…¨è¿‡ç¨‹ã€‚
- **å¤šæ™ºèƒ½ä½“åä½œ (Multi-Agent Collaboration)**ï¼šç³»ç»ŸåŒ…å«å››ç§æ ¸å¿ƒæ™ºèƒ½ä½“ï¼š
  - **æ€»ç›‘ (ChiefPlanner)**ï¼šä½œä¸ºå›¢é˜Ÿçš„ç®¡ç†è€…ï¼Œè´Ÿè´£è§£æžç”¨æˆ·åˆå§‹éœ€æ±‚ã€å®¡æŸ¥ä¸‹å±žå·¥ä½œã€æä¾›åé¦ˆï¼ˆReflectionï¼‰ï¼Œå¹¶å†³å®šä»»åŠ¡çš„ä¸‹ä¸€æ­¥èµ°å‘ã€‚
  - **è¡Œç¨‹ä¸“å®¶ (ItineraryExpert)**ï¼šè´Ÿè´£è§„åˆ’è¯¦ç»†çš„æ¯æ—¥è¡Œç¨‹ï¼Œåˆ©ç”¨å·¥å…·æœç´¢æ™¯ç‚¹ã€é¤åŽ…ç­‰ä¿¡æ¯ã€‚
  - **åŽå‹¤ä¸“å®¶ (LogisticsExpert)**ï¼šè´Ÿè´£è§„åˆ’ä½å®¿å’Œäº¤é€šï¼Œç¡®ä¿æ–¹æ¡ˆç¬¦åˆé¢„ç®—ã€‚
  - **æŠ¥å‘Šä¸“å‘˜ (ReportGenerator)**ï¼šè´Ÿè´£å°†æœ€ç»ˆç¡®å®šçš„è®¡åˆ’æ•´åˆæˆä¸€ä»½ç²¾ç¾Žçš„MarkdownæŠ¥å‘Šã€‚
- **å·¥å…·è°ƒç”¨ (Tool Invocation)**ï¼šæ™ºèƒ½ä½“é€šè¿‡è°ƒç”¨é¢„å®šä¹‰çš„å·¥å…·æ¥èŽ·å–å¤–éƒ¨ä¿¡æ¯æˆ–æ‰§è¡Œç‰¹å®šæ“ä½œã€‚æ™ºèƒ½ä½“åœ¨è°ƒç”¨å·¥å…·åŽä¼šæ ¹æ®è¿”å›žçš„ç»“æžœè¿›è¡Œä¸‹ä¸€æ­¥çš„æ€è€ƒå’Œå†³ç­–ã€‚
  - è¿™é‡Œæˆ‘è®¾ç½®çš„å·¥å…·æœ‰ï¼š
    - `tavily_search`ï¼šç”¨äºŽåœ¨çº¿æœç´¢ä¿¡æ¯ã€‚
    - `search_long_term_memory`ï¼šä»Žé•¿æœŸè®°å¿†ä¸­æ£€ç´¢ç›¸å…³ä¿¡æ¯ã€‚
    - `add_to_long_term_memory`ï¼šå°†æ–°çš„æ—…è¡Œè®¡åˆ’å­˜å…¥é•¿æœŸè®°å¿†ã€‚
    - `calculator`ï¼šç”¨äºŽæ‰§è¡Œç®€å•çš„æ•°å­¦è®¡ç®—ã€‚ï¼ˆä¸»è¦æ˜¯è®¡ç®—èŠ±è´¹é˜²æ­¢è¶…æ”¯ï¼‰
    - `generate_markdown_report`ï¼šå°†ç»“æž„åŒ–çš„æ—…è¡Œè®¡åˆ’è½¬æ¢ä¸º Markdown æ ¼å¼æŠ¥å‘Šã€‚
- **çŠ¶æ€å›¾ (StateGraph)**ï¼šä¸Žä¼ ç»Ÿçš„çº¿æ€§é“¾å¼è°ƒç”¨ä¸åŒï¼Œæœ¬å®žéªŒé‡‡ç”¨ LangGraph çš„ `StateGraph` æ¥å®šä¹‰å·¥ä½œæµç¨‹ã€‚å›¾ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªæ™ºèƒ½ä½“æˆ–ä¸€ä¸ªæ“ä½œï¼Œè¾¹åˆ™ä»£è¡¨çŠ¶æ€çš„æµè½¬ã€‚è¿™ç§ç»“æž„å…è®¸å®žçŽ°å¤æ‚çš„é€»è¾‘ï¼Œä¾‹å¦‚å°†ä»»åŠ¡ä»Žä¸“å®¶è¿”å›žç»™æ€»ç›‘è¿›è¡Œå®¡æŸ¥ï¼Œå½¢æˆä¸€ä¸ªâ€œåæ€-ä¿®æ”¹â€çš„å¾ªçŽ¯ï¼Œæžå¤§åœ°æå‡äº†è®¡åˆ’çš„è´¨é‡ã€‚
- **ReAct æ¡†æž¶**ï¼šè¡Œç¨‹å’ŒåŽå‹¤ä¸“å®¶é‡‡ç”¨ ReAct æ¨¡å¼å·¥ä½œã€‚å®ƒä»¬éµå¾ªâ€œ**æ€è€ƒ â†’ è¡ŒåŠ¨ â†’ è§‚å¯Ÿ**â€çš„å¾ªçŽ¯ã€‚é¦–å…ˆï¼Œæ™ºèƒ½ä½“åŸºäºŽå½“å‰ä»»åŠ¡è¿›è¡Œ**æ€è€ƒ**ï¼Œå†³å®šéœ€è¦ä»€ä¹ˆä¿¡æ¯ä»¥åŠä½¿ç”¨å“ªä¸ª**è¡ŒåŠ¨**ï¼ˆå·¥å…·ï¼‰ã€‚åœ¨æ‰§è¡Œå·¥å…·å¹¶èŽ·å¾—**è§‚å¯Ÿ**ï¼ˆç»“æžœï¼‰åŽï¼Œæ™ºèƒ½ä½“å°†æ–°ä¿¡æ¯èžå…¥ä¸‹ä¸€è½®æ€è€ƒï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆã€‚
- **é•¿æœŸè®°å¿† (Long-Term Memory)**ï¼šç³»ç»Ÿè®¾è®¡äº†ç®€å•çš„é•¿æœŸè®°å¿†æœºåˆ¶ã€‚åœ¨æ€»ç›‘æ‰¹å‡†ä¸€ä»½è®¡åˆ’åŽï¼Œè¯¥è®¡åˆ’ä¼šè¢«å­˜å…¥ä¸€ä¸ª JSON æ–‡ä»¶ã€‚å½“æŽ¥åˆ°æ–°çš„ç›¸ä¼¼ç›®çš„åœ°è¯·æ±‚æ—¶ï¼Œç³»ç»Ÿå¯ä»¥ä»Žè®°å¿†ä¸­æ£€ç´¢å¹¶å¤ç”¨å·²æœ‰è®¡åˆ’ï¼Œæé«˜äº†æ•ˆçŽ‡ã€‚

#### 2\. å…³é”®ä»£ç å±•ç¤º

##### 1\. çŠ¶æ€å®šä¹‰ (AgentState)

`AgentState` æ˜¯æ•´ä¸ªå·¥ä½œæµçš„æ ¸å¿ƒï¼Œå®ƒä»¥ä¸€ä¸ªå­—å…¸çš„å½¢å¼åœ¨æ‰€æœ‰èŠ‚ç‚¹é—´ä¼ é€’ï¼Œæ‰¿è½½äº†ä»»åŠ¡æ‰§è¡Œæ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚

```py
class AgentState(TypedDict):
    user_request: str                 # ç”¨æˆ·çš„åŽŸå§‹è¯·æ±‚
    user_profile: Dict                # æå–å‡ºçš„ç”¨æˆ·æ ¸å¿ƒåå¥½ (æ¨¡æ‹Ÿé•¿æœŸè®°å¿†)
    plan: Dict                        # å­˜å‚¨æ—…è¡Œè®¡åˆ’çš„ç»“æž„åŒ–æ•°æ®
    drafts: List[Dict]                # å„ä¸ªæ™ºèƒ½ä½“çš„è‰ç¨¿å’Œæ€è€ƒè¿‡ç¨‹
    reflection: Dict                  # æ€»ç›‘çš„åæ€å’Œä¿®æ”¹æ„è§
    final_report: str                 # æœ€ç»ˆçš„MarkdownæŠ¥å‘Š
    next_agent: str                   # å†³å®šä¸‹ä¸€ä¸ªæ‰§è¡Œçš„æ™ºèƒ½ä½“
```

  - é€šè¿‡ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†ï¼Œæ¯ä¸ªæ™ºèƒ½ä½“éƒ½èƒ½è®¿é—®åˆ°å…¨å±€ä¿¡æ¯ï¼Œä¾‹å¦‚ç”¨æˆ·åå¥½ã€å…¶ä»–æ™ºèƒ½ä½“å·²å®Œæˆçš„è‰ç¨¿ç­‰ï¼Œä¿è¯äº†åä½œçš„é¡ºç•…ã€‚
  - `next_agent` å­—æ®µæ˜¯å®žçŽ°åŠ¨æ€è·¯ç”±çš„å…³é”®ï¼Œç”±æ™ºèƒ½ä½“åœ¨å®Œæˆå·¥ä½œåŽè®¾ç½®ï¼ŒæŒ‡å¯¼å›¾çš„èµ°å‘ã€‚

##### 2\. å®šä¹‰å·¥å…· (Tools)

å·¥å…·æ˜¯æ™ºèƒ½ä½“ä¸Žå¤–éƒ¨ä¸–ç•Œäº¤äº’çš„æ¡¥æ¢ã€‚æœ¬å®žéªŒå®šä¹‰äº†å¤šç§å·¥å…·ï¼Œä¾‹å¦‚åœ¨çº¿æœç´¢ã€è®¡ç®—å™¨ã€é•¿æœŸè®°å¿†è¯»å†™ç­‰ã€‚

```py
@tool
def tavily_search(query: str) -> str:
    """
    ä½¿ç”¨Tavilyæœç´¢å¼•æ“Žåœ¨çº¿æŸ¥æ‰¾ä¿¡æ¯ã€‚
    """
    # ... å®žçŽ°ä»£ç  ...

@tool
def search_long_term_memory(destination: str) -> Union[Dict, str]:
    """
    ä»Žé•¿æœŸè®°å¿†ä¸­æœç´¢å…³äºŽç‰¹å®šç›®çš„åœ°çš„æ—…è¡Œè®¡åˆ’ã€‚
    """
    # ... å®žçŽ°ä»£ç  ...

@tool
def add_to_long_term_memory(destination: str, plan_data: Dict) -> str:
    """
    å°†ä¸€ä¸ªæ–°çš„æ—…è¡Œè®¡åˆ’æ·»åŠ åˆ°é•¿æœŸè®°å¿†ä¸­ã€‚
    """
    # ... å®žçŽ°ä»£ç  ...

@tool
def calculator(expression: str) -> str:
    """
    ä¸€ä¸ªç®€å•çš„è®¡ç®—å™¨å·¥å…·ï¼Œå¯ä»¥æ‰§è¡ŒåŸºæœ¬çš„æ•°å­¦è¿ç®—ã€‚
    """
    # ... å®žçŽ°ä»£ç  ...

@tool
def generate_markdown_report(plan: Dict) -> str:
    """
    ä½¿ç”¨LLMå°†ç»“æž„åŒ–çš„æ—…è¡Œè®¡åˆ’å­—å…¸è½¬æ¢æˆMarkdownæ ¼å¼æŠ¥å‘Šï¼ˆä¸­æ–‡ï¼‰ï¼Œå¹¶å°†å…¶ä¿å­˜ä¸ºæ–‡ä»¶ã€‚
    """
    # ... å®žçŽ°ä»£ç  ...
```

  - æ¯ä¸ªå·¥å…·éƒ½è¢« `@tool` è£…é¥°å™¨æ ‡è®°ï¼Œä½¿å…¶èƒ½è¢« LangChain æ¡†æž¶è‡ªåŠ¨è¯†åˆ«å’Œè°ƒç”¨ã€‚
  - ä¸“å®¶æ™ºèƒ½ä½“é€šè¿‡è°ƒç”¨è¿™äº›å·¥å…·æ¥èŽ·å–åˆ¶å®šè®¡åˆ’æ‰€éœ€çš„æ•°æ®ã€‚
- è¿™é‡ŒæŠ¥å‘Šç”Ÿæˆå·¥å…· `generate_markdown_report` å…¶å®žä¹Ÿè°ƒç”¨äº† LLMï¼Œä¸‹é¢å±•ç¤ºæç¤ºè¯
    ```py
    @tool
    def generate_markdown_report(plan: Dict) -> str:
        """
        ä½¿ç”¨LLMå°†ç»“æž„åŒ–çš„æ—…è¡Œè®¡åˆ’å­—å…¸è½¬æ¢æˆMarkdownæ ¼å¼æŠ¥å‘Šï¼ˆä¸­æ–‡ï¼‰ï¼Œå¹¶å°†å…¶ä¿å­˜ä¸ºæ–‡ä»¶ã€‚
        """
        print("--- TOOL: GENERATE MARKDOWN REPORT ---")
        
        prompt = f"""
        ä½œä¸ºä¸€åä¸“ä¸šçš„æ—…è¡Œè®¡åˆ’ä¹¦æ’°å†™ä¸“å®¶ï¼Œè¯·å°†ä»¥ä¸‹æ—…è¡Œè®¡åˆ’æ•°æ®è½¬æ¢ä¸ºç¾Žè§‚ã€æ˜“è¯»çš„ä¸­æ–‡Markdownæ ¼å¼æŠ¥å‘Šã€‚
        
        ## æ—…è¡ŒåŸºæœ¬ä¿¡æ¯
        - ç›®çš„åœ°: {plan['destination']}
        - æ—…è¡Œæ—¶é•¿: {plan['duration']}
        - é¢„ç®—: {plan['budget']}
        - æ—…å®¢å…´è¶£ç‚¹: {', '.join(plan['interests'])}
        
        ## è¡Œç¨‹å®‰æŽ’
        {json.dumps(plan.get('itinerary', {}), ensure_ascii=False, indent=2)}
        
        ## åŽå‹¤ä¿¡æ¯
        {json.dumps(plan.get('logistics', {}), ensure_ascii=False, indent=2)}
        
        ## å¤‡é€‰æ–¹æ¡ˆ
        {json.dumps(plan.get('alternatives', {}), ensure_ascii=False, indent=2)}
        
        è¯·ç”Ÿæˆä¸€ä»½å®Œæ•´çš„ã€ç»“æž„æ¸…æ™°çš„Markdownæ ¼å¼æ—…è¡Œè®¡åˆ’ï¼Œç¡®ä¿:
        1. åŒ…å«ç²¾ç¾Žçš„æ ‡é¢˜å’Œå°æ ‡é¢˜ï¼ˆå¯ä»¥æ·»åŠ ç›¸å…³çš„å›¾æ ‡æˆ–æ ·å¼ï¼‰
        2. ä¸ºæ¯æ—¥è¡Œç¨‹æ·»åŠ è¯¦ç»†æè¿°ï¼ŒåŒ…æ‹¬ä¸»é¢˜ã€æ´»åŠ¨å’Œé¤é¥®å»ºè®®ï¼ˆè¯¦ç»†ï¼‰
        3. æ ¼å¼åŒ–æ‰€æœ‰è´¹ç”¨ä¿¡æ¯ï¼Œä½¿å…¶æ˜“äºŽé˜…è¯»
        4. å°†é¤é¥®å»ºè®®æ ¼å¼åŒ–ä¸ºæ˜“è¯»çš„åˆ—è¡¨ï¼ŒåŒ…å«èœå“æŽ¨èå’Œè¯„ä»·ï¼ˆè¯¦ç»†ï¼‰
        5. åŽå‹¤éƒ¨åˆ†åº”æ¸…æ™°å±•ç¤ºä½å®¿å’Œäº¤é€šä¿¡æ¯
        6. ä½¿ç”¨Markdownè¯­æ³•ç¡®ä¿å†…å®¹ç¾Žè§‚ã€å±‚æ¬¡åˆ†æ˜Ž
        
        åªéœ€è¿”å›žçº¯Markdownæ ¼å¼ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæˆ–å‰å¯¼è¯­ã€‚
        """
        
        messages = [HumanMessage(content=prompt)]
        response = llm.invoke(messages)
        markdown_report = response.content

        try:
            filename = f"æ—…è¡Œè®¡åˆ’_{plan.get('destination', 'æœªçŸ¥ç›®çš„åœ°')}.md"
            with open(filename, 'w', encoding='utf-8') as f:
                f.write(markdown_report)
            print(f"--- TOOL: REPORT EXPORTED --- \nSaved to: {filename}")
        except Exception as e:
            print(f"--- TOOL: REPORT EXPORT FAILED --- \nError: {e}")
        
        return markdown_report
    ```
##### 3\. ç»“æž„åŒ–è¾“å‡ºï¼ˆPydantic Modelsï¼‰
ä¸ºäº†ç¡®ä¿æ™ºèƒ½ä½“çš„è¾“å‡ºç¬¦åˆé¢„æœŸæ ¼å¼ï¼Œæˆ‘ä»¬ä½¿ç”¨ Pydantic å®šä¹‰äº†ç»“æž„åŒ–çš„è¾“å‡ºæ¨¡åž‹ã€‚

```py
class PlanDecision(BaseModel):
    """ç”¨äºŽè§£æžåˆå§‹ç”¨æˆ·è¯·æ±‚çš„ç»“æž„ã€‚"""
    destination: str = Field(description="æ—…è¡Œç›®çš„åœ°")
    duration: str = Field(description="æ—…è¡Œæ—¶é—´")
    budget: str = Field(description="æ—…è¡Œé¢„ç®—")
    interests: List[str] = Field(description="å®¢æˆ·çš„å…´è¶£ç‚¹")
    next_agent: AgentType = Field(description="ä¸‹ä¸€ä¸ªåº”è¯¥å¼€å§‹å·¥ä½œçš„ä¸“å®¶", default=AgentType.ITINERARY_EXPERT)

class ReviewDecision(BaseModel):
    """ç”¨äºŽè§£æžæ€»ç›‘å®¡æŸ¥å†³ç­–çš„ç»“æž„ã€‚"""
    decision: str = Field(description="å®¡æŸ¥å†³å®šï¼Œ'APPROVE' æˆ– 'REVISE'")
    feedback: Union[str, None] = Field(description="å¦‚æžœå†³å®šæ˜¯ 'REVISE'ï¼Œè¯·æä¾›å…·ä½“çš„ä¿®æ”¹æ„è§", default=None)
    next_agent: AgentType = Field(description="ä¸‹ä¸€ä¸ªæ™ºèƒ½ä½“ï¼š'ReportGenerator' (å¦‚æžœæ‰¹å‡†) æˆ–éœ€è¦ä¿®æ”¹çš„ä¸“å®¶ (å¦‚æžœä¿®æ”¹)")
```

  - `PlanDecision` ç”¨äºŽè§£æžæ€»ç›‘æ™ºèƒ½ä½“å¯¹ç”¨æˆ·è¯·æ±‚çš„åˆæ­¥åˆ†æžç»“æžœï¼ŒåŒ…å«ç›®çš„åœ°ã€é¢„ç®—ç­‰å…³é”®ä¿¡æ¯ã€‚
  - `ReviewDecision` ç”¨äºŽæ€»ç›‘å®¡æŸ¥ä¸‹å±žæäº¤çš„è®¡åˆ’è‰ç¨¿ï¼Œå†³å®šæ˜¯å¦æ‰¹å‡†æˆ–éœ€è¦ä¿®æ”¹ã€‚


##### 4\. æ™ºèƒ½ä½“èŠ‚ç‚¹ (Agents)

- æ¯ä¸ªæ™ºèƒ½ä½“è¢«å®žçŽ°ä¸ºä¸€ä¸ªå‡½æ•°ï¼ŒæŽ¥æ”¶å¹¶è¿”å›ž `AgentState`ã€‚

###### (1) chief_planner_agent

æ€»ç›‘æ™ºèƒ½ä½“è´Ÿè´£è§£æžç”¨æˆ·è¯·æ±‚ã€å®¡æŸ¥ä¸“å®¶æäº¤çš„è‰ç¨¿ï¼Œå¹¶å†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨ã€‚

```py
def chief_planner_agent(state: AgentState) -> AgentState:
    """
    æ€»ç›‘æ™ºèƒ½ä½“ (ChiefPlanner)
    - æŽ¥æ”¶ç”¨æˆ·è¯·æ±‚ï¼Œæå–æ ¸å¿ƒä¿¡æ¯
    - å®¡æŸ¥è‰ç¨¿ï¼Œæä¾›åé¦ˆ (å®žçŽ°Reflection)
    - å†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨
    """
    if not state.get("plan"): # ä»»åŠ¡å¼€å§‹
        parser = PydanticOutputParser(pydantic_object=PlanDecision)
        prompt = f"""
        ä½ æ˜¯ä¸€ä¸ªé«˜ç«¯æ—…è¡Œå·¥ä½œå®¤çš„æ€»ç›‘ã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ†æžå®¢æˆ·çš„åˆå§‹è¯·æ±‚ï¼Œå¹¶å§”æ´¾ä»»åŠ¡ç»™ä½ çš„å›¢é˜Ÿã€‚
        
        å®¢æˆ·è¯·æ±‚: "{state['user_request']}"
        
        ä½ çš„å·¥ä½œ:
        1.  ä»Žè¯·æ±‚ä¸­æå–å…³é”®ä¿¡æ¯ï¼šç›®çš„åœ°ã€æ—¶é—´ã€é¢„ç®—ã€ä¸ªäººå…´è¶£ç­‰ç­‰ã€‚
        2.  å†³å®šä¸‹ä¸€æ­¥åº”è¯¥ç”±å“ªä¸ªä¸“å®¶å¼€å§‹å·¥ä½œã€‚
        
        {parser.get_format_instructions()}
        """
        # åˆ›å»ºé“¾å¹¶è°ƒç”¨
        chain = llm | parser
        parsed_output = chain.invoke(prompt)

        # æ›´æ–°çŠ¶æ€
        state["user_profile"] = {
            "destination": parsed_output.destination,
            "duration": parsed_output.duration,
            "budget": parsed_output.budget,
            "interests": parsed_output.interests
        }
        state["plan"] = {}
        
        print(f"--- CHIEF PLANNER: Checking long-term memory for {parsed_output.destination} ---")
        memory_result = search_long_term_memory.invoke({"destination": parsed_output.destination})
        
        if isinstance(memory_result, dict):
            print("--- CHIEF PLANNER: Found existing plan in memory. Using it as a base. ---")
            state['plan'] = memory_result.get('plan', {})
            state["next_agent"] = AgentType.CHIEF_PLANNER.value
        else:
            print("--- CHIEF PLANNER: No existing plan found. Starting from scratch. ---")
            state["next_agent"] = parsed_output.next_agent.value
        
    else: # Reflection
        itinerary_done = 'itinerary' in state['plan']
        logistics_done = 'logistics' in state['plan']
        
        if not itinerary_done:
             state["next_agent"] = AgentType.ITINERARY_EXPERT.value
             return state
        if not logistics_done:
            state["next_agent"] = AgentType.LOGISTICS_EXPERT.value
            return state

        parser = PydanticOutputParser(pydantic_object=ReviewDecision)
        prompt = f"""
        ä½ æ˜¯ä¸€ä¸ªé«˜ç«¯æ—…è¡Œå·¥ä½œå®¤çš„æ€»ç›‘ï¼Œæ­£åœ¨å®¡æŸ¥ä¸‹å±žæäº¤çš„æ—…è¡Œè®¡åˆ’è‰ç¨¿ã€‚
        
        å®¢æˆ·æ ¸å¿ƒæ¡£æ¡ˆ: {state['user_profile']}
        
        å½“å‰è®¡åˆ’è‰ç¨¿: {state['plan']}
        
        ä½ çš„ä»»åŠ¡ (Reflection):
        1. æ£€æŸ¥ 'itinerary' æ˜¯å¦è¯¦ç»†ä¸”ç¬¦åˆå®¢æˆ·çš„å…´è¶£({state['user_profile']['interests']})ã€‚
        2. æ£€æŸ¥æ¯ä¸ªæ™¯ç‚¹æ˜¯å¦æä¾›äº†åœ°å€ï¼Œé¤é¥®æ˜¯å¦åŒ…å«ç½‘å‹è¯„è®ºã€‚
        3. å®¡æŸ¥è´¹ç”¨ä¼°ç®—æ˜¯å¦åˆç†ï¼Œæ¯æ—¥è´¹ç”¨æ€»å’Œæ˜¯å¦åœ¨å®¢æˆ·é¢„ç®—({state['user_profile']['budget']})èŒƒå›´å†…ã€‚
        4. æ£€æŸ¥ 'logistics' çš„å»ºè®®æ˜¯å¦ç¬¦åˆå®¢æˆ·çš„é¢„ç®—ã€‚
        5. å¦‚æžœä¸€åˆ‡éƒ½å¥½ï¼Œè¯·å†³å®šä¸‹ä¸€æ­¥è¿›å…¥æŠ¥å‘Šç”ŸæˆçŽ¯èŠ‚ã€‚è¾“å‡º "APPROVE"ã€‚
        6. å¦‚æžœæœ‰é—®é¢˜ï¼Œè¯·æå‡ºå…·ä½“çš„ä¿®æ”¹æ„è§å’Œéœ€è¦è¿”å·¥çš„ä¸“å®¶åç§°ã€‚

        {parser.get_format_instructions()}
        """
        chain = llm | parser
        parsed_output = chain.invoke(prompt)

        if parsed_output.decision.upper() == "REVISE":
            state["next_agent"] = parsed_output.next_agent.value
            state['reflection'] = {"feedback": parsed_output.feedback}
        else:
            print("--- CHIEF PLANNER: Plan approved. Saving to long-term memory before generating report. ---")
            add_to_long_term_memory.invoke({
                "destination": state["user_profile"]["destination"],
                "plan_data": {
                    "user_profile": state["user_profile"],
                    "plan": state["plan"]
                }
            })
            state["next_agent"] = AgentType.REPORT_GENERATOR.value

    return state
```
  - æ€»ç›‘æ™ºèƒ½ä½“å¤§è‡´åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š
    - **ä»»åŠ¡åˆ†é…**ï¼šåœ¨ä»»åŠ¡å¼€å§‹æ—¶ï¼Œè§£æžç”¨æˆ·è¯·æ±‚ï¼Œæå–å…³é”®ä¿¡æ¯ï¼Œå¹¶å†³å®šä¸‹ä¸€ä¸ªæ‰§è¡Œçš„æ™ºèƒ½ä½“ã€‚
    - **å®¡æŸ¥ä¸Žåæ€**ï¼šåœ¨ä»»åŠ¡å®ŒæˆåŽï¼Œå®¡æŸ¥ä¸“å®¶æ™ºèƒ½ä½“æäº¤çš„è‰ç¨¿ï¼Œå†³å®šæ˜¯å¦æ‰¹å‡†æˆ–éœ€è¦ä¿®æ”¹ï¼Œå¹¶æä¾›åé¦ˆã€‚
  - ä¸ºäº†æ–¹ä¾¿ï¼Œåˆ©ç”¨ `llm | parser` çš„æ–¹å¼åˆ›å»ºäº†ä¸€ä¸ª**é“¾ï¼ˆchainï¼‰**ï¼Œå°† LLM å’Œ Pydantic è¾“å‡ºè§£æžå™¨è¿žæŽ¥èµ·æ¥ï¼Œç®€åŒ–äº†è¾“å‡ºçš„å¤„ç†ã€‚
  - åœ¨åˆå§‹è§£æžçš„æ—¶å€™ï¼Œ**å…ˆæ£€æŸ¥**é•¿æœŸè®°å¿†ä¸­æ˜¯å¦å·²æœ‰ç›¸å…³çš„æ—…è¡Œè®¡åˆ’ã€‚å¦‚æžœæœ‰ï¼Œåˆ™å†æ¬¡è°ƒç”¨æ€»ç›‘æ™ºèƒ½ä½“çš„é€»è¾‘æ¥å†³å®šæ˜¯å¦å¤ç”¨å·²æœ‰è®¡åˆ’ï¼Œé¿å…é‡å¤åŠ³åŠ¨ã€‚ï¼ˆä¹Ÿé¿å…ç”±äºŽæ—¶é—´è·¨åº¦è¿‡å¤§å¯¼è‡´çš„è®¡åˆ’è¿‡æ—¶é—®é¢˜ï¼‰ï¼Œå¦‚æžœæ²¡æœ‰ï¼Œåˆ™å¼€å§‹æ–°çš„è§„åˆ’æµç¨‹ã€‚
  - åœ¨å®¡æŸ¥é˜¶æ®µï¼Œå…ˆæ€»ä½“åˆ¤æ–­ä¸¤ä¸ªéƒ¨åˆ†ï¼š`itinerary` å’Œ `logistics` æ˜¯å¦å®Œæˆï¼Œè‹¥æ²¡æœ‰å®Œæˆåˆ™ç›´æŽ¥è¿”å›žéœ€è¦æ‰§è¡Œçš„æ™ºèƒ½ä½“ç±»åž‹ã€‚å¦‚æžœéƒ½å®Œæˆäº†ï¼Œåˆ™è¿›å…¥**å®¡æŸ¥é€»è¾‘**ï¼Œæ£€æŸ¥è®¡åˆ’çš„ç»†èŠ‚æ˜¯å¦ç¬¦åˆç”¨æˆ·éœ€æ±‚ï¼Œå¹¶å†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨ã€‚
  
###### (2) expert_agent_react

è¡Œç¨‹å’ŒåŽå‹¤ä¸“å®¶æ™ºèƒ½ä½“é‡‡ç”¨ ReAct æ¨¡å¼å·¥ä½œï¼Œè´Ÿè´£å…·ä½“çš„è®¡åˆ’åˆ¶å®šã€‚

```py
def expert_agent_react(state: AgentState, agent_name: str) -> AgentState:
    """
    ä¸“å®¶æ™ºèƒ½ä½“ (è¡Œç¨‹/åŽå‹¤)
    - ä½¿ç”¨ ReAct æ¨¡å¼: æ€è€ƒ -> è¡ŒåŠ¨(å·¥å…·) -> è§‚å¯Ÿ -> å›žç­”
    - å®ƒåªè´Ÿè´£è‡ªå·±é¢†åŸŸå†…çš„è§„åˆ’ã€‚
    """
    task_description = ""
    if agent_name == "ItineraryExpert":
        task_description = f"""
        ä¸ºæœŸ {state['user_profile']['duration']} çš„ {state['user_profile']['destination']} ä¹‹æ—…ï¼Œè§„åˆ’ä¸€ä»½è¯¦ç»†çš„æ¯æ—¥è¡Œç¨‹ã€‚
        å®¢æˆ·å¯¹ {state['user_profile']['interests']} ç‰¹åˆ«æ„Ÿå…´è¶£ã€‚
        æ€»é¢„ç®—ä¸º {state['user_profile']['budget']}ã€‚
        
        ä½ éœ€è¦ï¼š
        1. ä¸ºæ¯ä¸ªæ™¯ç‚¹æˆ–åœ°ç‚¹æŸ¥æ‰¾å¹¶æä¾›è¯¦ç»†åœ°å€
        2. ä¸ºæŽ¨èçš„é¤åŽ…æˆ–å°åƒæŸ¥æ‰¾å¹¶æä¾›çœŸå®žçš„ç½‘å‹è¯„è®º
        3. ä¼°ç®—æ¯ä¸ªæ´»åŠ¨å’Œé¤é¥®çš„è´¹ç”¨ï¼Œå¹¶è®¡ç®—æ¯æ—¥æ€»èŠ±è´¹ï¼Œç¡®ä¿ä¸è¶…è¿‡æ€»é¢„ç®—
        """
        # å¦‚æžœæœ‰æ€»ç›‘çš„ä¿®æ”¹æ„è§ï¼ŒåŠ å…¥åˆ°æç¤ºä¸­
        if state.get('reflection') and 'ItineraryExpert' in state['reflection'].get('feedback', ''):
            task_description += f"\nä¿®æ”¹æ„è§: {state['reflection']['feedback']}"
            state['reflection'] = {} # æ¸…é™¤æ„è§
            
    elif agent_name == "LogisticsExpert":
        task_description = f"""
        ä¸º {state['user_profile']['destination']} çš„æ—…è¡Œæä¾›ä½å®¿å’Œäº¤é€šå»ºè®®ï¼Œæ€»é¢„ç®—ä¸º {state['user_profile']['budget']}ã€‚
        è¯·æä¾›ä½å®¿çš„å…·ä½“åœ°å€ã€ä»·æ ¼ï¼Œä»¥åŠä»Žä¸€ä¸ªåœ°ç‚¹åˆ°å¦ä¸€ä¸ªåœ°ç‚¹çš„äº¤é€šæ–¹å¼å’Œè´¹ç”¨ä¼°ç®—ã€‚
        """

    # ReAct Prompt
    prompt = f"""
    ä½ æ˜¯ {agent_name}ã€‚ä½ çš„ä»»åŠ¡æ˜¯: {task_description}
    
    è¯·éµå¾ª"æ€è€ƒ -> è¡ŒåŠ¨ -> è§‚å¯Ÿ -> å›žç­”"çš„æ¨¡å¼ (ReAct)ã€‚
    é¦–å…ˆï¼Œä½ éœ€è¦æ€è€ƒä½ éœ€è¦å“ªäº›ä¿¡æ¯ï¼Œç„¶åŽä½¿ç”¨ä½ å¯ç”¨çš„å·¥å…·({tavily_search.name}, {calculator.name})æ¥æŸ¥æ‰¾è¿™äº›ä¿¡æ¯æˆ–è¿›è¡Œè®¡ç®—ã€‚
    åœ¨ä½ æ”¶é›†åˆ°è¶³å¤Ÿçš„ä¿¡æ¯åŽï¼Œè¯·ä»¥JSONæ ¼å¼æ€»ç»“ä½ çš„æœ€ç»ˆè§„åˆ’æ–¹æ¡ˆã€‚JSONå¿…é¡»åŒ…å«åœ¨ä¸€ä¸ªä»£ç å—ä¸­ã€‚
    
    ä¾‹å¦‚, å¯¹äºŽ ItineraryExpert, æœ€ç»ˆçš„JSONè¾“å‡ºæ ¼å¼åº”ä¸º:
    ```json
    {{
      "itinerary": {{
        "ç¬¬ä¸€å¤©": {{ "theme": "...", "activities": ["...", "..."], "dining_suggestion": "..." }},
        "ç¬¬äºŒå¤©": {{ "theme": "...", "activities": ["...", "..."], "dining_suggestion": "..." }}
      }},
      "alternatives": {{ "å¤‡é€‰æ´»åŠ¨": "..." }}
    }}
    ã…¤```  
    
    å¯¹äºŽ LogisticsExpert, æœ€ç»ˆçš„JSONè¾“å‡ºæ ¼å¼åº”ä¸º:
    ```json
    {{
      "logistics": {{
        "accommodation": "...",
        "transportation": "..."
      }},
      "alternatives": {{ "å¤‡é€‰é…’åº—": "..." }}
    }}
    ã…¤```

    çŽ°åœ¨ï¼Œè¯·å¼€å§‹ä½ çš„å·¥ä½œã€‚å…ˆæ€è€ƒï¼Œç„¶åŽå†³å®šæ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·ã€‚
    """
    
    # ReAct å¾ªçŽ¯
    llm_with_tools = llm.bind_tools([tavily_search, calculator])
    messages = [HumanMessage(content=prompt)]
    for i in range(5): # æœ€å¤šè¿›è¡Œ5è½®
        print(f"\n--- {agent_name} ReAct Loop: Step {i+1} ---")
        
        response = llm_with_tools.invoke(messages)
        messages.append(response) # å°†æ¨¡åž‹çš„å“åº”åŠ å…¥åŽ†å²è®°å½•

        # æ£€æŸ¥æ¨¡åž‹æ˜¯å¦è¦è°ƒç”¨å·¥å…· (è¡ŒåŠ¨)
        if response.tool_calls:
            print(f"--- ReAct: Tool call detected by the model. ---")
            for tool_call in response.tool_calls:
                # æ‰§è¡Œå·¥å…·
                if tool_call['name'] == tavily_search.name:
                    tool_result = tavily_search.invoke(tool_call["args"])
                elif tool_call['name'] == calculator.name:
                    tool_result = calculator.invoke(tool_call["args"])
                else:
                    tool_result = "æœªçŸ¥å·¥å…·"
                    
                print(f"--- ReAct: Tool '{tool_call['name']}' executed. ---")
                # å°†è§‚å¯Ÿç»“æžœåŠ å…¥åŽ†å²è®°å½•
                messages.append(ToolMessage(content=str(tool_result), tool_call_id=tool_call["id"]))
            continue

        # å¦‚æžœæ²¡æœ‰å·¥å…·è°ƒç”¨ï¼Œåˆ™è®¤ä¸ºæ˜¯æœ€ç»ˆå›žç­”
        print("--- ReAct: No tool call detected. Assuming final answer. ---")
        json_match = re.search(r"```json\n(.*?)\n```", response.content, re.DOTALL)
        if json_match:
            plan_json_str = json_match.group(1)
            try:
                plan_update = json.loads(plan_json_str)
                state["plan"].update(plan_update)
                state["next_agent"] = AgentType.CHIEF_PLANNER.value
                print("--- ReAct: Successfully parsed final JSON answer. ---")
                return state
            except json.JSONDecodeError as e:
                print(f"--- ReAct: Error decoding JSON: {e} ---")
                # å‘ŠçŸ¥æ¨¡åž‹JSONé”™è¯¯ï¼Œè®©å…¶ä¿®æ­£
                error_message = HumanMessage(content=f"ä½ çš„JSONæ ¼å¼æœ‰è¯¯ï¼Œè¯·ä¿®æ­£: {e}")
                messages.append(error_message)
                continue

        # å¦‚æžœæ—¢æ²¡æœ‰å·¥å…·è°ƒç”¨ä¹Ÿæ²¡æœ‰æœ‰æ•ˆJSONï¼Œè®©å®ƒå†è¯•ä¸€æ¬¡
        print("--- ReAct: No valid action or final answer detected, retrying... ---")

    # å¦‚æžœå¾ªçŽ¯ç»“æŸä»æœªå¾—åˆ°æœ‰æ•ˆç»“æžœ
    print(f"--- {agent_name}: Failed to get a valid plan after multiple attempts. ---")
    state["next_agent"] = AgentType.CHIEF_PLANNER.value  # è¿”å›žç»™æ€»ç›‘å¤„ç†
    return state
```

- `expert_agent_react` å…¶å®žæ˜¯ä¸€ä¸ªé€šç”¨çš„ä¸“å®¶æ™ºèƒ½ä½“å‡½æ•°ï¼Œå®ƒæ ¹æ®ä¼ å…¥çš„ `agent_name` å‚æ•°æ¥å†³å®šæ˜¯è¡Œç¨‹ä¸“å®¶è¿˜æ˜¯åŽå‹¤ä¸“å®¶ã€‚
  - **è¡Œç¨‹ä¸“å®¶**ï¼šè´Ÿè´£åˆ¶å®šæ¯æ—¥è¡Œç¨‹ï¼Œæœç´¢æ™¯ç‚¹å’Œé¤é¥®ä¿¡æ¯ï¼Œå¹¶è®¡ç®—è´¹ç”¨ã€‚
  - **åŽå‹¤ä¸“å®¶**ï¼šè´Ÿè´£è§„åˆ’ä½å®¿å’Œäº¤é€šï¼Œç¡®ä¿ç¬¦åˆé¢„ç®—ã€‚
- ä½¿ç”¨ ReAct æ¨¡å¼ï¼Œæ™ºèƒ½ä½“åœ¨æ¯ä¸€æ­¥éƒ½å…ˆæ€è€ƒéœ€è¦ä»€ä¹ˆä¿¡æ¯ï¼Œç„¶åŽè°ƒç”¨å·¥å…·èŽ·å–æ•°æ®ï¼Œæœ€åŽå°†ç»“æžœä»¥ JSON æ ¼å¼è¿”å›žã€‚
  - åœ¨æ¯æ¬¡å¾ªçŽ¯ä¸­ï¼Œæ™ºèƒ½ä½“ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·ï¼ˆè¡ŒåŠ¨ï¼‰ï¼Œå¦‚æžœæœ‰ï¼Œåˆ™æ‰§è¡Œå·¥å…·å¹¶å°†ç»“æžœä½œä¸ºè§‚å¯Ÿï¼ˆObservationï¼‰åŠ å…¥åˆ°å¯¹è¯åŽ†å²ä¸­ã€‚
  - å¦‚æžœæ²¡æœ‰å·¥å…·è°ƒç”¨ï¼Œåˆ™è®¤ä¸ºæ˜¯æœ€ç»ˆå›žç­”ï¼Œå¹¶å°è¯•è§£æž JSON è¾“å‡ºï¼Œå°†ç»“æžœæ›´æ–°åˆ° `state["plan"]` ä¸­ã€‚
- ä¸ç®¡æœ‰æ²¡æœ‰äº§ç”Ÿæ»¡æ„çš„è¾“å‡ºï¼Œæ™ºèƒ½ä½“ä¼šè¿”å›žç»™æ€»ç›‘è¿›è¡Œå¤„ç†ã€‚ï¼ˆå†³å®šæƒå½’å›žæ€»ç›‘ï¼‰


###### (3) report_generator_agent
æŠ¥å‘Šç”Ÿæˆæ™ºèƒ½ä½“è´Ÿè´£å°†æœ€ç»ˆçš„æ—…è¡Œè®¡åˆ’è½¬æ¢ä¸º Markdown æ ¼å¼çš„æŠ¥å‘Šã€‚

```py
def report_generator_agent(state: AgentState) -> AgentState:
    """
    æŠ¥å‘Šç”Ÿæˆä¸“å‘˜
    - è°ƒç”¨è‡ªå®šä¹‰å·¥å…·ï¼Œå°†æœ€ç»ˆç¡®è®¤çš„è®¡åˆ’æ ¼å¼åŒ–ä¸ºMarkdown
    """
    print("\n--- AGENT: ReportGenerator ---")
    
    complete_plan = {
        "destination": state["user_profile"]["destination"],
        "duration": state["user_profile"]["duration"],
        "budget": state["user_profile"]["budget"],
        "interests": state["user_profile"]["interests"]
    }

    complete_plan.update(state['plan'])
    

    markdown_report = generate_markdown_report.invoke({"plan": complete_plan})
    state['final_report'] = markdown_report
    state['next_agent'] = AgentType.END.value  # ä»»åŠ¡ç»“æŸ
    return state
```
- `report_generator_agent` è´Ÿè´£å°†æœ€ç»ˆçš„æ—…è¡Œè®¡åˆ’è½¬æ¢ä¸º Markdown æ ¼å¼çš„æŠ¥å‘Šï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°æ–‡ä»¶ä¸­ã€‚

##### 5\. å®šä¹‰å›¾ (Graph)

ä½¿ç”¨ `StateGraph` å°†æ‰€æœ‰æ™ºèƒ½ä½“èŠ‚ç‚¹è¿žæŽ¥èµ·æ¥ï¼Œå¹¶å®šä¹‰å®ƒä»¬ä¹‹é—´çš„è·³è½¬é€»è¾‘ã€‚

```py
workflow = StateGraph(AgentState)

# æ·»åŠ èŠ‚ç‚¹
workflow.add_node("ChiefPlanner", chief_planner_agent)
workflow.add_node("ItineraryExpert", lambda state: expert_agent_react(state, "ItineraryExpert"))
workflow.add_node("LogisticsExpert", lambda state: expert_agent_react(state, "LogisticsExpert"))
workflow.add_node("ReportGenerator", report_generator_agent)

# è®¾ç½®å…¥å£ç‚¹
workflow.set_entry_point("ChiefPlanner")

# å®šä¹‰æ¡ä»¶è¾¹ï¼Œå®žçŽ°åŠ¨æ€è·¯ç”±
workflow.add_conditional_edges(
    "ChiefPlanner",
    route_tasks, # ä¸€ä¸ªæ ¹æ® state['next_agent'] è¿”å›žèŠ‚ç‚¹åçš„å‡½æ•°
    {
        "ItineraryExpert": "ItineraryExpert",
        "LogisticsExpert": "LogisticsExpert",
        "ReportGenerator": "ReportGenerator",
    }
)

# å®šä¹‰å¸¸è§„è¾¹ï¼Œä¸“å®¶å®ŒæˆåŽè¿”å›žæ€»ç›‘å®¡æŸ¥
workflow.add_edge("ItineraryExpert", "ChiefPlanner")
workflow.add_edge("LogisticsExpert", "ChiefPlanner")

# æŠ¥å‘Šç”ŸæˆåŽç»“æŸ
workflow.add_edge("ReportGenerator", END)

# ç¼–è¯‘å›¾
graph = workflow.compile()
```
- `add_conditional_edges` æ˜¯æž„å»ºå¤æ‚å·¥ä½œæµçš„æ ¸å¿ƒã€‚å®ƒå…è®¸å›¾æ ¹æ®æ€»ç›‘ï¼ˆæˆ–ä»»ä½•å…¶ä»–èŠ‚ç‚¹ï¼‰çš„å†³ç­–åŠ¨æ€åœ°å°†ä»»åŠ¡è·¯ç”±åˆ°ä¸åŒçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»Žè€Œå®žçŽ°å®¡æŸ¥ã€è¿”å·¥ç­‰å¾ªçŽ¯é€»è¾‘ã€‚
    ```mermaid
    stateDiagram-v2
        [*] --> ChiefPlanner

        ChiefPlanner --> ItineraryExpert : next_agent == ItineraryExpert
        ChiefPlanner --> LogisticsExpert : next_agent == LogisticsExpert
        ChiefPlanner --> ReportGenerator : next_agent == ReportGenerator

        ItineraryExpert --> ChiefPlanner
        LogisticsExpert --> ChiefPlanner
        ReportGenerator --> [*]
    ```

##### 6\. ä¸»å‡½æ•°è°ƒç”¨

åœ¨ä¸»å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åˆå§‹åŒ–çŠ¶æ€å¹¶è°ƒç”¨ç¼–è¯‘å¥½çš„å›¾ã€‚

```py
def main():
    initial_request = "ä½ å¥½ï¼Œæˆ‘å’Œæˆ‘ç”·æœ‹å‹æƒ³åŽ»ä¸­å›½å¹¿ä¸œæ½®æ±•çŽ©å››å¤©ã€‚é¢„ç®—åœ¨ä¸‰åƒå·¦å³ã€‚æˆ‘ä»¬å¯¹å½“åœ°ç¾Žé£Ÿéžå¸¸æ„Ÿå…´è¶£ï¼ŒåŒæ—¶ä¹Ÿæƒ³å‚è§‚å½“åœ°ä¸€äº›åèƒœæ™¯åœ°ï¼Œå¸Œæœ›èƒ½æœ‰ä¸€ä¸ªæ·±åº¦æ¸¸çš„ä½“éªŒã€‚"
    
    initial_state = AgentState(...)
    
    # ä½¿ç”¨ stream æ–¹æ³•æ‰§è¡Œå›¾ï¼Œå¯ä»¥è§‚å¯Ÿæ¯ä¸€æ­¥çš„è¾“å‡º
    for output in graph.stream(initial_state, config={"recursion_limit": 100}):
        if "__end__" not in output:
            for key, value in output.items():
                print(f"--- Node '{key}' Output ---")
                final_state = value
    
    # æ‰“å°æœ€ç»ˆæŠ¥å‘Š
    print(final_state['final_report'])
```

  - `graph.stream` æ–¹æ³•èƒ½å¤Ÿè®©æˆ‘ä»¬å®žæ—¶è¿½è¸ªå·¥ä½œæµçš„æ¯ä¸€æ­¥æ‰§è¡Œæƒ…å†µï¼Œéžå¸¸ä¾¿äºŽè°ƒè¯•å’Œè§‚å¯Ÿæ™ºèƒ½ä½“çš„åä½œè¿‡ç¨‹ã€‚

#### 3\. åˆ›æ–°ç‚¹&ä¼˜åŒ–

  - **åˆ†å±‚-å¾ªçŽ¯å¼å·¥ä½œæµ**ï¼šé‡‡ç”¨äº†â€œæ€»ç›‘-ä¸“å®¶â€çš„åˆ†å±‚ç»“æž„ï¼Œå¹¶é€šè¿‡ `StateGraph` å®žçŽ°äº†â€œè§„åˆ’-å®¡æŸ¥-ä¿®æ”¹â€çš„å¾ªçŽ¯å·¥ä½œæµã€‚è¿™æ¯”ç®€å•çš„é¡ºåºå¼æ™ºèƒ½ä½“é“¾æ¡æ›´ä¸ºå¼ºå¤§å’Œå¯é ï¼Œèƒ½æ˜¾è‘—æå‡æœ€ç»ˆäº§å‡ºçš„è´¨é‡ã€‚
  - **æŒä¹…åŒ–é•¿æœŸè®°å¿†**ï¼šé€šè¿‡ `add_to_long_term_memory` å·¥å…·ï¼Œç³»ç»Ÿèƒ½å°†é«˜è´¨é‡çš„æ—…è¡Œè®¡åˆ’æŒä¹…åŒ–ä¿å­˜ã€‚è¿™ä½¿å¾—æ™ºèƒ½ä½“ç³»ç»Ÿå…·å¤‡äº†å­¦ä¹ å’Œç»éªŒç§¯ç´¯çš„èƒ½åŠ›ï¼Œåœ¨æœªæ¥å¤„ç†ç›¸ä¼¼ä»»åŠ¡æ—¶æ›´åŠ é«˜æ•ˆã€‚
  - **é²æ£’çš„å·¥å…·è®¾è®¡**ï¼šä¸º `tavily_search` å·¥å…·å¢žåŠ äº†é€ŸçŽ‡é™åˆ¶ï¼ˆ`@limits`ï¼‰å’ŒæŒ‡æ•°é€€é¿é‡è¯•ï¼ˆ`@on_exception`ï¼‰çš„è£…é¥°å™¨ï¼Œå¤§å¤§å¢žå¼ºäº†å·¥å…·åœ¨é¢å¯¹çœŸå®žä¸–ç•ŒAPIé™åˆ¶æ—¶çš„ç¨³å®šæ€§å’Œé²æ£’æ€§ã€‚
  - **ç»“æž„åŒ–è¾“å‡ºå¼ºåˆ¶è§£æž**ï¼šå¹¿æ³›ä½¿ç”¨ Pydantic æ¨¡åž‹ï¼ˆå¦‚ `PlanDecision`, `ReviewDecision`ï¼‰å’Œ `PydanticOutputParser` æ¥çº¦æŸå’Œè§£æžå¤§æ¨¡åž‹çš„è¾“å‡ºã€‚è¿™ä¿è¯äº†ç¨‹åºæŽ§åˆ¶æµçš„ç¨³å®šæ€§ï¼Œé¿å…äº†å› æ¨¡åž‹è¾“å‡ºæ ¼å¼éšæ„è€Œå¯¼è‡´çš„ç¨‹åºå´©æºƒã€‚

### ä¸‰ã€å®žéªŒç»“æžœåŠåˆ†æž

#### å®žéªŒç»“æžœ

- è¿™é‡Œä»¥â€œæ½®æ±•æ—…è¡Œè®¡åˆ’â€ä¸ºä¾‹ï¼Œå±•ç¤ºäº†ç³»ç»Ÿçš„å·¥ä½œæµç¨‹å’Œæœ€ç»ˆäº§å‡ºã€‚ï¼ˆ**æ³¨æ„ï¼šä»¥ä¸‹å†…å®¹ä¸ºæ¨¡æ‹Ÿç¤ºä¾‹ï¼Œå®žé™…è¿è¡Œç»“æžœå¯èƒ½æœ‰æ‰€ä¸åŒ**ï¼‰

>   - åˆå§‹è¯·æ±‚ï¼š`ä½ å¥½ï¼Œæˆ‘å’Œæˆ‘ç”·æœ‹å‹æƒ³åŽ»ä¸­å›½å¹¿ä¸œæ½®æ±•çŽ©å››å¤©ã€‚é¢„ç®—åœ¨ä¸‰åƒå·¦å³ã€‚æˆ‘ä»¬å¯¹å½“åœ°ç¾Žé£Ÿéžå¸¸æ„Ÿå…´è¶£ï¼ŒåŒæ—¶ä¹Ÿæƒ³å‚è§‚å½“åœ°ä¸€äº›åèƒœæ™¯åœ°ï¼Œå¸Œæœ›èƒ½æœ‰ä¸€ä¸ªæ·±åº¦æ¸¸çš„ä½“éªŒã€‚`
>   - ç³»ç»Ÿæ‰§è¡Œæµç¨‹ï¼š
>     1.  **ChiefPlanner** èŠ‚ç‚¹å¯åŠ¨ï¼ŒæˆåŠŸè§£æžç”¨æˆ·éœ€æ±‚ï¼Œæå–å‡ºç›®çš„åœ°â€œæ½®æ±•â€ã€æ—¶é•¿â€œå››å¤©â€ã€é¢„ç®—â€œä¸‰åƒå·¦å³â€å’Œå…´è¶£â€œç¾Žé£Ÿã€åèƒœæ™¯åœ°ã€æ·±åº¦æ¸¸â€ã€‚
>     2.  ä»»åŠ¡è¢«è·¯ç”±åˆ° **ItineraryExpert**ã€‚è¯¥ä¸“å®¶é€šè¿‡è°ƒç”¨ `tavily_search` å·¥å…·ï¼Œæœç´¢äº†æ½®æ±•çš„è‘—åæ™¯ç‚¹ï¼ˆå¦‚å¹¿æµŽæ¡¥ã€ç‰ŒåŠè¡—ï¼‰å’Œç‰¹è‰²ç¾Žé£Ÿï¼ˆå¦‚ç‰›è‚‰ç«é”…ã€èšçƒ™ï¼‰ï¼Œå¹¶åˆ¶å®šäº†è¯¦ç»†çš„å››æ—¥è¡Œç¨‹è‰æ¡ˆã€‚
>     3.  ä»»åŠ¡è¿”å›ž **ChiefPlanner** è¿›è¡Œå®¡æŸ¥ã€‚æ€»ç›‘æ‰¹å‡†äº†è¡Œç¨‹è‰æ¡ˆã€‚
>     4.  ä»»åŠ¡è¢«è·¯ç”±åˆ° **LogisticsExpert**ã€‚è¯¥ä¸“å®¶æœç´¢äº†ç¬¦åˆé¢„ç®—çš„é…’åº—å’Œå½“åœ°äº¤é€šæ–¹å¼ï¼ˆå¦‚å…¬äº¤ã€ç½‘çº¦è½¦ï¼‰ï¼Œå¹¶æ·»åŠ åˆ°è®¡åˆ’ä¸­ã€‚
>     5.  ä»»åŠ¡å†æ¬¡è¿”å›ž **ChiefPlanner** è¿›è¡Œæœ€ç»ˆå®¡æŸ¥ã€‚æ€»ç›‘æ‰¹å‡†äº†å®Œæ•´çš„è®¡åˆ’ï¼Œå¹¶è°ƒç”¨ `add_to_long_term_memory` å·¥å…·å°†è®¡åˆ’å­˜å…¥ `long_term_memory.json`ã€‚
>     6.  ä»»åŠ¡è¢«è·¯ç”±åˆ° **ReportGenerator**ã€‚è¯¥ä¸“å‘˜è°ƒç”¨ `generate_markdown_report` å·¥å…·ï¼Œå°†ç»“æž„åŒ–çš„è®¡åˆ’æ•°æ®è½¬æ¢æˆä¸€ä»½æ ¼å¼ç²¾ç¾Žçš„ Markdown æŠ¥å‘Šï¼Œå¹¶ä¿å­˜ä¸º `æ—…è¡Œè®¡åˆ’_æ½®æ±•.md` æ–‡ä»¶ã€‚
>     7.  ä»»åŠ¡åˆ°è¾¾ **END** èŠ‚ç‚¹ï¼Œæ‰§è¡Œå®Œæ¯•ã€‚

  - **æœ€ç»ˆäº§å‡º**ï¼šç³»ç»ŸæˆåŠŸç”Ÿæˆäº†ä¸€ä»½è¯¦ç»†çš„Markdownæ ¼å¼æ—…è¡Œè®¡åˆ’æŠ¥å‘Šã€‚
    - ![alt text](images/image.png)

> - æˆ‘è¿˜æµ‹è¯•äº†â€œä¸­å›½å°æ¹¾å°åŒ—â€â€œä¸­å›½ç¦å»ºæ³‰å·žâ€ä¸¤ä¸ªæ—…è¡Œç›®çš„åœ°ï¼Œè§ [æ—…è¡Œè®¡åˆ’_ä¸­å›½ç¦å»ºæ³‰å·ž.md](./æ—…è¡Œè®¡åˆ’_ä¸­å›½ç¦å»ºæ³‰å·ž.md) å’Œ [æ—…è¡Œè®¡åˆ’_ä¸­å›½å°æ¹¾å°åŒ—.md](./æ—…è¡Œè®¡åˆ’_ä¸­å›½å°æ¹¾å°åŒ—.md)ã€‚
> - ![alt text](images/image-1.png)

#### åˆ†æž
  - **å¤šæ™ºèƒ½ä½“ä¼˜åŠ¿**ï¼šç›¸æ¯”äºŽæ™®é€šçš„å•æ™ºèƒ½ä½“ç³»ç»Ÿï¼Œæœ¬å®žéªŒçš„å¤šæ™ºèƒ½ä½“åä½œç³»ç»Ÿç”±äºŽ**æµç¨‹æ¸…æ¥šï¼Œæœé›†èµ„æ–™é½å…¨**ï¼Œèƒ½åœ¨é’ˆå¯¹æœç´¢å‡ºçš„ä¿¡æ¯è¿›è¡Œç»¼åˆåˆ†æžåŽï¼Œåˆ¶å®šå‡ºæ›´ä¸ºè¯¦å°½å’Œä¸ªæ€§åŒ–çš„æ—…è¡Œè®¡åˆ’ã€‚æˆ‘åœ¨æµ‹è¯•å®Œä¸»æµåœ¨çº¿èŠå¤©æœºå™¨äººï¼ˆå¦‚ ChatGPTã€Google Geminiï¼‰åŽå‘çŽ°ï¼šæœ¬å®žéªŒçš„ç³»ç»Ÿåœ¨å¤„ç†å¤æ‚ä»»åŠ¡æ—¶è¡¨çŽ°æ›´ä¸ºå‡ºè‰²ï¼Œä¿¡æ¯è¯¦å°½ä¸”ç»“æž„åŒ–ï¼Œèƒ½æ›´å¥½åœ°æ»¡è¶³ç”¨æˆ·ä¸ªæ€§åŒ–éœ€æ±‚ã€‚
  - **å·¥ä½œæµæœ‰æ•ˆæ€§**ï¼šå®žéªŒç»“æžœè¡¨æ˜Žï¼ŒåŸºäºŽ `StateGraph` æž„å»ºçš„å¤šæ™ºèƒ½ä½“åä½œæµç¨‹æ˜¯å®Œå…¨æœ‰æ•ˆçš„ã€‚ä»»åŠ¡åœ¨æ€»ç›‘å’Œä¸“å®¶ä¹‹é—´æ­£ç¡®åœ°æµè½¬ï¼Œ**å®¡æŸ¥å’Œè¿”å·¥çš„å¾ªçŽ¯æœºåˆ¶**ç¡®ä¿äº†å„ä¸ªéƒ¨åˆ†çš„è®¡åˆ’éƒ½ç¬¦åˆç”¨æˆ·è¦æ±‚ã€‚ï¼ˆè¿™ä¹Ÿæ˜¯æœ€ç»ˆäº§å‡ºé«˜è´¨é‡æŠ¥å‘Šçš„å…³é”®ï¼‰
  - **æ™ºèƒ½ä½“èƒ½åŠ›**ï¼šå„æ™ºèƒ½ä½“è¡¨çŽ°å‡ºäº†è‰¯å¥½çš„ä¸“ä¸šèƒ½åŠ›ã€‚ä¸“å®¶æ™ºèƒ½ä½“é€šè¿‡ **ReAct** æ¨¡å¼æˆåŠŸåœ°åˆ©ç”¨å·¥å…·æ”¶é›†ä¿¡æ¯å¹¶å®Œæˆè§„åˆ’ã€‚æ€»ç›‘æ™ºèƒ½ä½“åˆ™æœ‰æ•ˆåœ°æ‰®æ¼”äº†é¡¹ç›®ç»ç†å’Œè´¨æ£€å‘˜çš„è§’è‰²ã€‚
  - **ç³»ç»Ÿé²æ£’æ€§**ï¼šç»“æž„åŒ–çš„ Pydantic è§£æžå’Œå¸¦å¼‚å¸¸å¤„ç†çš„å·¥å…·è®¾è®¡ï¼Œä½¿å¾—æ•´ä¸ªç³»ç»Ÿè¿è¡Œç¨³å®šã€‚å³ä½¿ LLM çš„è¾“å‡ºå¶å°”å‡ºçŽ°å¾®å°åå·®ï¼ŒPydantic è§£æžå™¨ä¹Ÿèƒ½ç¡®ä¿ç¨‹åºæµç¨‹çš„æ­£ç¡®æ€§ã€‚
#### æ½œåœ¨é—®é¢˜
- æœ€ç»ˆè®¡åˆ’çš„è´¨é‡é«˜åº¦ä¾èµ–äºŽ LLM çš„èƒ½åŠ›å’Œæœç´¢å·¥å…·è¿”å›žä¿¡æ¯çš„å‡†ç¡®æ€§ã€‚å¦‚æžœæœç´¢ç»“æžœè´¨é‡ä¸é«˜æˆ–ä¿¡æ¯è¿‡æ—¶ï¼Œä¸“å®¶æ™ºèƒ½ä½“åˆ¶å®šçš„è®¡åˆ’ä¹Ÿå¯èƒ½å­˜åœ¨äº‹å®žé”™è¯¯ã€‚æ­¤å¤–ï¼Œå½“å‰ ReAct å¾ªçŽ¯æ¬¡æ•°å›ºå®šä¸º5æ¬¡ï¼Œå¯¹äºŽæ›´å¤æ‚çš„è°ƒç ”ä»»åŠ¡å¯èƒ½ä¸è¶³ã€‚
- ç”±äºŽå—é™äºŽ API è°ƒç”¨é€ŸçŽ‡å’Œå·¥å…·çš„å“åº”æ—¶é—´ï¼Œç³»ç»Ÿåœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®æ—¶å¯èƒ½ä¼šé‡åˆ°æ€§èƒ½ç“¶é¢ˆã€‚å°¤å…¶æ˜¯åœ¨éœ€è¦å¤šæ¬¡è°ƒç”¨å¤–éƒ¨ API çš„æƒ…å†µä¸‹ï¼Œæ•´ä½“å“åº”æ—¶é—´å¯èƒ½è¾ƒé•¿ã€‚
- ç”±äºŽ API è´¨é‡ä¸é«˜ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœç´¢ç»“æžœä¸å‡†ç¡®æˆ–ä¸å®Œæ•´ï¼Œæœªæ¥å¯ä»¥å®žçŽ°ä¿¡æ¯ä¾¦æŸ¥å’ŒéªŒè¯æœºåˆ¶ï¼Œç¡®ä¿æœ€ç»ˆè®¡åˆ’çš„å¯é æ€§ã€‚
- åœ°å›¾å…¶å®žæ˜¯æœ€ç›´æŽ¥çš„å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©ç”¨æˆ·æ›´å¥½åœ°ç†è§£è¡Œç¨‹å®‰æŽ’å’Œåœ°ç†ä½ç½®ã€‚ç”±äºŽä¸€èˆ¬çš„åˆ¶å›¾å·¥å…·éœ€è¦é¢å¤–çš„ API è°ƒç”¨ï¼Œå½“å‰ç³»ç»Ÿæœªé›†æˆåœ°å›¾åŠŸèƒ½ã€‚æœªæ¥å¯ä»¥è€ƒè™‘å¼•å…¥åœ°å›¾ç”Ÿæˆå·¥å…·ï¼Œå°†è¡Œç¨‹å¯è§†åŒ–ã€‚
- é•¿æœŸè®°å¿†çš„å®žçŽ°è¾ƒä¸ºç®€å•ï¼Œå½“å‰ä»…æ”¯æŒå­˜å‚¨å’Œæ£€ç´¢ JSON æ ¼å¼çš„æ—…è¡Œè®¡åˆ’ã€‚æœªæ¥å¯ä»¥è€ƒè™‘å¼•å…¥æ›´å¤æ‚çš„é•¿æœŸè®°å¿†ç³»ç»Ÿï¼Œä¾‹å¦‚åŸºäºŽå‘é‡æ•°æ®åº“çš„å­˜å‚¨å’Œæ£€ç´¢ï¼Œä»¥æ”¯æŒæ›´çµæ´»çš„ä¿¡æ¯æŸ¥è¯¢å’Œå¤ç”¨ã€‚
- ç”±äºŽå½“å‰ç³»ç»Ÿçš„è®¾è®¡æ˜¯åŸºäºŽç‰¹å®šçš„æ—…è¡Œè§„åˆ’ä»»åŠ¡ï¼Œæ™ºèƒ½ä½“ä¹‹é—´çš„åä½œå’ŒçŠ¶æ€ä¼ é€’è¾ƒä¸ºå›ºå®šã€‚æœªæ¥å¯ä»¥è€ƒè™‘å¼•å…¥æ›´çµæ´»çš„ä»»åŠ¡è·¯ç”±æœºåˆ¶ï¼Œä½¿å¾—æ™ºèƒ½ä½“èƒ½å¤Ÿæ ¹æ®å®žé™…æƒ…å†µåŠ¨æ€è°ƒæ•´å·¥ä½œæµç¨‹ã€‚

### å››ã€å‚è€ƒæ–‡çŒ®
>   - [LangGraph Documentation](https://langchain-ai.github.io/langgraph/)
>   - [Why LangGraph?](https://langchain-ai.github.io/langgraph/concepts/why-langgraph/)